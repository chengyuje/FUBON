eSoafApp.directive("eSmartTag",["$filter",function(e){return{restrict:"A",require:"ngModel",scope:{},link:function(e,t,r,a){function n(t){"A1"===e.EditMask&&(e.DataExt="U"),"U"===e.DataExt?t.style.textTransform="uppercase":"L"===e.DataExt&&(t.style.textTransform="lowercase")}function i(t,r){if(r>0&&""!==e.FillType){if("L"===e.EditType)return l(t,e.FillType,r);if("R"===e.EditType)return u(t,e.FillType,r)}return t}function u(e,t,r){if(e.length<r){var a=[];a.push(e);for(var n=r-e.length,i=0;n>i;i++)a.push(t);return a.join("")}return e}function l(e,t,r){if(e.length<r){for(var a=new Array,n=r-e.length,i=0;n>i;i++)a.push(t);return a.push(e),a.join("")}return e}function s(e){console.log(e);var t=getToday();return t.substr(0,t.length-e.length)+e}function o(e){var t,r=new RegExp("[^0-9]","g");if(e=e.replace(r,""),8===e.length&&(r=new RegExp("([0-9]{2,4})([0-9]{2})([0-9]{2})","g"),null!=(t=r.exec(e)))){var a=parseInt(t[1]),n=parseInt(t[2]),i=parseInt(t[3]);try{var u=new Date(a,n-1,i);if(u.getFullYear()==a&&u.getMonth()==n-1&&u.getDate()==i)return!0}catch(l){}}return!1}function v(e,t){t="undefined"!=typeof t?t:"/";var r=new RegExp("([0-9]{2,4})([0-9]{2})([0-9]{2})","g"),a=e.replace(r,"$1"+t+"$2"+t+"$3");return a}function f(e,t){var r;t="undefined"!=typeof t?t:"/";var a=new RegExp("([0-9]{2,4})([0-9]{2})([0-9]{2})","g");if(null!=(r=a.exec(e))){var n=r[1];return n=l((parseInt(n,10)-1911).toString(),"0",3),e.replace(a,n+t+"$2"+t+"$3")}return e.replace(a,"$1"+t+"$2"+t+"$3")}function d(t,r){var a;if("C1"===e.EditMask||"C2"===e.EditMask){var n=new RegExp("([0-9]{2,4})([0-9]{2})([0-9]{2})","g");if(null!=(a=n.exec(t))){var i=parseInt(a[1]);return console.log("trans2CYear="+i.toString()),r?(i-=1911,t.replace(n,l(i.toString(),"0",3)+"$2$3")):(i+=1911,t.replace(n,i.toString()+"$2$3"))}}return t}function p(e,t,r){if(e=e.trim(),""!=e){var a,n=new RegExp("^([+-]?)([0-9]*)(\\.?)([0-9]*)$","g");if(null!=(a=n.exec(e))){var i=a[1],l=a[2];l=l.replace(/(^0*)/g,""),""==l&&(l="0");var s=l;if(r){var o=new RegExp("([0-9]{1,3})(?=([0-9]{3})+(?:$|\\.))","g");s=l.replace(o,"$1,")}e=t>a[4].length?i+s+"."+u(a[4].toString(),"0",t):0==t?i+s:i+s+a[3]+a[4]}}return e}function g(e,t){if(t>0){var r,a=new RegExp("^([+-]{0,1}[0-9]*)\\.?[0-9]{0,"+t.toString()+"}$");return null!=(r=a.exec(e))?!0:!1}var a=new RegExp("^[+-]{0,1}[0-9]*$");return a.test(e)}function E(t){if("U"===e.DataExt?t.value=t.value.toUpperCase():"L"===e.DataExt&&(t.value=t.value.toLowerCase()),("D1"===e.EditMask||"D2"===e.EditMask||"C1"===e.EditMask||"C2"===e.EditMask)&&t.value.length>0)return t.value=s(t.value),o(t.value);if("N1"===e.EditMask||"N2"===e.EditMask||"N3"===e.EditMask||"N4"===e.EditMask)return g(t.value,e.Frac)?(t.value=p(t.value,e.Frac,!1),!0):!1;if("A1"===e.EditMask&&t.value.length>0){var r=new RegExp("[A-Z][12][0-9]{8}","g");return r.test(t.value)}if("A2"===e.EditMask&&t.value.length>0){var r=new RegExp("[0-9]{8}","g");return r.test(t.value)}return!0}function c(t){if("D1"===e.EditMask||"D2"===e.EditMask)return v(t);if("C1"===e.EditMask||"C2"===e.EditMask)return f(t);if("N1"===e.EditMask||"N2"===e.EditMask||"N3"===e.EditMask||"N4"===e.EditMask){var r="N2"===e.EditMask||"N4"===e.EditMask;return p(t,e.Frac,r)}return t}function h(e){return 8===e||46===e||35===e||36===e||37===e||38===e||39===e||40===e}function k(e,t){var r={188:"44",109:"45",190:"46",191:"47",192:"96",220:"92",222:"39",221:"93",219:"91",173:"45",187:"61",186:"59",189:"45"},a={96:"~",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",48:")",45:"_",61:"+",91:"{",93:"}",92:"|",59:":",39:'"',44:"<",46:">",47:"?"},n=e.toString();return r.hasOwnProperty(n)&&(n=r[n],e=parseInt(n,10)),n=!t&&e>=65&&90>=e?String.fromCharCode(e+32):t&&a.hasOwnProperty(n)?a[n]:String.fromCharCode(e)}a&&(console.log("Link"),e.Frac=parseInt(r.datafrac||"0",10),e.DataFormat=r.dataformat||"Z",e.EditMask=r.editmask||e.DataFormat,"D1"===e.EditMask||"D2"===e.EditMask||"C1"===e.EditMask||"C2"===e.EditMask?e.DataFormat="N":("N1"===e.EditMask||"N2"===e.EditMask||"N3"===e.EditMask||"N4"===e.EditMask)&&(e.DataFormat="$"),e.EditType=r.edittype||"N",e.FillType="","N"!==e.EditType&&e.EditType.length>=2&&(e.FillType=e.EditType.substr(1,1),e.EditType=e.EditType.substr(0,1).toUpperCase()),e.DataExt=r.dataext||"N",t.bind("focus",function(){n(this),this.value=d(a.$viewValue,!0)}),t.bind("keydown",function(){var t=event.shiftKey,r=event.keyCode||event.which,a=9===r&&t;if(!a&&!h(r)){var n=k(r,t);if(console.log("keydown="+n),"N"===e.DataFormat){var i=new RegExp("[0-9]");return void(i.test(n)||(event.preventDefault?event.preventDefault():event.returnValue=!1))}if("$"===e.DataFormat){var i=new RegExp("[+\\-\\.0-9]");return void(i.test(n)||(event.preventDefault?event.preventDefault():event.returnValue=!1))}}}),t.bind("blur",function(){this.value=d(this.value,!1);var e=this.value,t=E(this);t&&this.value.length>0&&(this.value=i(this.value,this.maxLength),console.log(this.value),a.$setViewValue(this.value),a.$render(),e=c(this.value),e!==this.value&&(this.value=e)),this.style.background=t?"#ffffff":"red"}),a.$render=function(){console.log("$render"),t.val(c(a.$modelValue))})}}}]);