/**================================================================================================
@program: eUpload.js
@description: JQuery
@version: 1.0.20170313
=================================================================================================*/
eSoafApp.directive("eUpload",["sysInfoService","$rootScope","$q","$timeout",function(t,e,r,a){return{restrict:"E",transclude:!0,replace:!0,scope:{model:"=?",allow:"@?",width:"@?",allowSize:"@?",accept:"@?",success:"&",fail:"&",process:"=?",processStr:"@?process",ngDisabled:"=?"},template:function(t,e){var r='<div style="height:30px;">	<table style="width:100%;height:30px;"><tr>		<td align="right" style="margin:0px;padding:0px;width:77%;height:30px;">        	<div ng-show="showBar" id="progress_loading_wrapper" class="progress" style="height:30px!important;width:100%!important;">				<div class="progress-bar progress-bar-primary progress-bar-striped active" role="progressbar" aria-valuenow="{{w}}" aria-valuemin="0" aria-valuemax="100" ng-style="{width:w+\'%\'}" style="line-height:30px;">					{{wStr}}				</div>			</div>        	<input ng-show="!showBar" style="height:30px;" class="form-control" type="text" value="{{value}}" disabled>		</td>		<td align="left" style="margin:0px;padding:0px;width:23%;height:30px;"><span id="filebtn" class="btn btn-info fileinput-button" style="height:30px;margin:0px;border-bottom-left-radius:0;border-top-left-radius:0;">				<input id="fileup" style="height:30px;margin:0px;padding:0px;" type="file" ng-model="eUpload_input">    			<span style="height:30px;margin:0px;padding:0px;">{{text}}</span>		</span></td>	</tr></table></div>';return r},link:function(i,s,n,l){i.showBar=!1;var o=$(s).find("#filebtn"),p=$(s).find("#fileup");i.width=i.width||"200px",$(s).css("width",i.width);var d=!1;if(n.functionType?a(function(){t.getAuthorities().MODULEID[t.$currentModule]&&t.getAuthorities().MODULEID[t.$currentModule].ITEMID[i.$parent.authority_txnName]&&(d=t.getAuthorities().MODULEID[t.$currentModule].ITEMID[i.$parent.authority_txnName].FUNCTIONID[n.functionType]),o.attr("disabled",!d),p.attr("disabled",!d)}):d=!0,i.ngDisabled){if(!d)return;o.attr("disabled",i.ngDisabled),p.attr("disabled",i.ngDisabled)}i.$watch("ngDisabled",function(t,e){d&&t!=e&&(1==t&&(i.value=""),o.attr("disabled",t),p.attr("disabled",t))});var u={str:!1,size:!1},c=[function(){var e=r.defer();return u.str=$.map(t.getFileParameter(),function(t){return"DEFAULT"==t.DATA?t.LABEL.toString().trim():void 0})[0],e.resolve(u.str),e.promise},function(){var e=r.defer();return u.size=$.map(t.getFileParameter(),function(t){return"DEFAULT"==t.DATA?1024*parseInt(t.LABEL.toString().trim())*1024:void 0})[0],e.resolve(u.size),e.promise}];r.all([c[0](),c[1]()]).then(function(){var e=$.map(t.getFileParameter(),function(t){return t.DATA==i.$parent.authority_txnName?parseInt(t.LABEL.toString().trim()):void 0})[0];e&&(u.str=e,u.size=1024*e*1024)}).then(function(){i.text="瀏覽",$(p).fileupload({url:"FileUpload",dataType:"json",change:function(t,r){var a=r.files[0].name.split(".")[r.files[0].name.split(".").length-1];if(i.allow){-1!==i.allow.indexOf(".")&&(i.allow=i.allow.replace(".",""));var s=i.allow.split(",");if(-1===s.indexOf(a))return i.value="",e.showWarningMsg("上傳檔案類型錯誤，檔案格式限定"+i.allow+"。"),!1}if(i.accept){-1!==i.accept.indexOf(".")&&(i.accept=i.accept.replace(".",""));var n=i.accept.split(",");if(-1===n.indexOf(a))return i.value="",e.showWarningMsg("上傳檔案類型錯誤，檔案格式限定"+i.accept+"。"),!1}if(u.str=i.allowSize||u.str,u.size=1024*u.str*1024,r.files[0].size>u.size)return i.value="",e.showWarningMsg("檔案大小不能超過"+u.str+"Mb。"),!1;i.showBar=!0,i.$parent[i.processStr]=0,o.attr("disabled",!0);var l=/(?:\.([^.]+))?$/;$.each(r.files,function(t,e){var a=uuid(),s=l.exec(e.name)[1],n=e.name,o=e.size;void 0!=s&&(a+="."+s),r.paramName=a;var d="temp/"+a;$(p).attr("fullPath",d),$(p).attr("name",a),$(p).attr("rname",n),$(p).attr("size",o),i.value=n})},progressall:function(t,e){if(t.isDefaultPrevented())return!1;var r=($(this),Math.floor(e.loaded/e.total*100));i.w=r,i.wStr=r+"%"},fail:function(t,e,r){return 200==e._response.jqXHR.status?(i.success({tempPath:$(p).attr("tempPath"),fullPath:$(p).attr("fullPath"),name:$(p).attr("name"),rname:$(p).attr("rname"),size:$(p).attr("size")}),$(p).attr("value",""),i.$parent[i.processStr]=100,i.showBar=!1,i.w=0,i.wStr="0%",void o.attr("disabled",!1)):void 0==$(p).attr("error")?(alert("上傳失敗, status["+e._response.jqXHR.status+"]"),i.$parent[i.processStr]=!1,i.showBar=!1,i.w=0,void(i.wStr="0%")):(i.error({status:e._response.jqXHR.status}),i.$parent[i.processStr]=!1,i.showBar=!1,void o.attr("disabled",!1))}})}),angular.isDefined(i.model)&&i.$watch("model",function(t,e){return t&&""!=t?i.value=t:i.value=""})}}}]);