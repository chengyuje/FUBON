eSoafApp.directive("eTableFreeze",["$q","$timeout",function(e,f){return{restrict:"C",scope:{eMode:"@?",eScroll:"=?",eHeight:"@?",eWidth:"@?",eSide:"@?",eTop:"@?",eLeft:"@?",eList:"=?"},transclude:!0,template:'<div ng-repeat="ft in ftables track by $index" e-index="{{ft}}" ng-transclude></div>',link:function(l,c,e,t){l.ftables=l.eTop&&"true"===l.eTop&&!l.eLeft?[0,1]:!l.eTop||"false"===l.eTop&&l.eLeft?[0,2,3]:[0,1,2,3],f(function(){l.freeze()}),l.freeze=function(){var u=!!l.eLeft&&parseInt(l.eLeft),e=$(c).attr("class").replace("e-table-freeze","").replace(/ng\-\S+/g,""),y=$(c).addClass("sticky-enabled").prepend($(c).find('[e-index="0"]').children()).css({margin:0,width:"100%"}).wrap('<div class="sticky-wrap"/>'),t=y.parent(".sticky-wrap").attr("style",function(){var e="";return l.eWidth&&(e+="max-width:"+l.eWidth+";"),l.eHeight&&(e+="max-height:"+l.eHeight+";"),e}),d=0<$(c).find('[e-index="1"]').length&&l.eTop&&"true"===l.eTop?$('<table class="sticky-thead table"></table>').addClass(e).append($(c).find('[e-index="1"]').children()).css({margin:0,width:"100%",display:"none",opacity:0,border:0}).appendTo(t).find("tbody").remove().end():null,a=0<$(c).find('[e-index="2"]').length&&u?$('<table class="sticky-col table"></table>').addClass(e).append($(c).find('[e-index="2"]').children()).css({margin:0,width:"100%",display:"none",opacity:0,"border-top":0,"border-left":0}).appendTo(t).find("thead").remove().end():null,o=0<$(c).find('[e-index="3"]').length&&u?$('<table class="sticky-intersect table"></table>').addClass(e).append($(c).find('[e-index="3"]').children()).css({margin:0,width:"100%",display:"none",opacity:0}).appendTo(t).find("tbody").remove().end():null,e={},b=0,n=[],i=!1;l.eScroll?(l.eTop?e["overflow-y"]="auto":e["overflow-y"]="hidden",l.eLeft?e["overflow-x"]="auto":e["overflow-x"]="hidden"):(e["overflow-y"]="auto",e["overflow-x"]="auto"),t.css(e),t.on("scroll",function(){l._top(),l._left()}),$(window).on("resize",function(){r(),l._top(),l._left()}),l.$watch(function(){return $("html,body").css("overflow")},function(e,t){e!==t&&"1"===l.eIndex&&d.outerWidth(y[0].getBoundingClientRect().width)}),l.$watch(function(){return $(c).width()},function(e,t){e&&e!==t&&f(function(){r()})}),l.$watchCollection("eList",function(e,t){$(c).find("[ng-if]").each(function(){var e=$(this).attr("ng-if");n.indexOf(e)<0&&(n.push(e),l.$watch(function(){return l.$parent.$eval(e)},function(e,t){e!==t&&f(function(){r()})}))}),$(c).find("[ng-show]").each(function(){var e=$(this).attr("ng-show");n.indexOf(e)<0&&(n.push(e),l.$watch(function(){return l.$parent.$eval(e)},function(e,t){e!==t&&f(function(){r()})}))}),e&&f(function(){0<$(c).find("div tbody").length&&(y&&y.append($(c).find('[e-index="0"]').children()),d&&d.append($(c).find('[e-index="1"]').children()).find("tbody").remove().end(),a&&a.append($(c).find('[e-index="2"]').children()).find("thead").remove().end(),o&&o.append($(c).find('[e-index="3"]').children()).find("tbody").remove().end()),a&&0<a.find("[ng-change]").length&&a.find("[ng-change]").each(function(){$(this).attr("ng-change","")}),r(),i=!1})}),l.$watch(function(){return t.is(":visible")},function(e,t){e&&e!==t&&f(function(){r()})}),l.$watch(function(){return y.is(":visible")},function(e,t){!1===e&&(d&&d.hide(),a&&a.hide(),o&&o.hide())});function s(e,f){var p=y.find("thead tr"),h={},g={},h={},g={};e.find("thead tr").each(function(e){for(var t=h[e]||0,n=0,i=$(this).find("th"),d=i.length,n=0;n<d;n++){var a=i.eq(n),o=parseInt(a.attr("colspan")||1),s=parseInt(a.attr("rowspan")||1),r=p.eq(e).find("th").eq(n)[0].getBoundingClientRect().width;if(a.removeClass("removeCell"),!a.hasClass("ng-hide")&&"none"!=a.css("display")){if(!(o&&t<f)){--n;break}t+=o;for(var l=0;l<s;l++)h[e+l]||(h[e+l]=0),h[e+l]+=o,h[e+l]>=f&&(h[e+l]=f),g[e+l]||(g[e+l]=0),g[e+l]+=r,g[e+l]>=b&&(g[e+l]-=r);var c=p.eq(e).find("th").eq(n);if(a.outerWidth(c[0].getBoundingClientRect().width).outerHeight(c[0].getBoundingClientRect().height).css({"padding-right":c.css("padding-right")?c.css("padding-right"):0,"padding-left":c.css("padding-left")?c.css("padding-left"):0,"padding-top":0,"padding-bottom":0}),f<=t){a.attr("colspan",o-(t-f)),(g[e]||b<0+r)&&a.outerWidth(b-(g[e]||0));break}}}(n<0?$(this).find("th"):$(this).find("th:gt("+(n||0)+")")).addClass("removeCell")})}var r=function(){l.eLeft&&parseInt(l.eLeft);y.find("thead tr"),y.find("tbody tr");var e=!!l.eLeft&&parseInt(l.eLeft),t={};l.eTop&&"true"===l.eTop&&d&&(t["sticky-thead"]=d.is(":visible"),t.top=d.css("top"),t["sticky-thead"]?d.css({opacity:1,display:"table",top:t.top}):d.css({opacity:0,display:"none"}),d.find("tr").each(function(t){$(this).find("th").each(function(e){e=y.find("thead tr").eq(t).find("th").eq(e);$(this).outerWidth(e[0].getBoundingClientRect().width).outerHeight(e[0].getBoundingClientRect().height),$(this).css({"vertical-align":"middle","padding-right":e.css("padding-right")?e.css("padding-right"):0,"padding-left":e.css("padding-left")?e.css("padding-left"):0,"padding-top":0,"padding-bottom":0})})}).end().outerWidth(y[0].getBoundingClientRect().width).outerHeight(y.find("thead")[0].getBoundingClientRect().height));var n,f,p,h,g,i=e?function(){for(var e=y.find("tbody tr"),t=0,n={},i={},d=0,a=e.length,o=b=0;o<a;o++){for(var s=e.eq(o).find("td"),r=s.length,l=0,l=(n[o],i[o],0);l<r;l++){var c=s.eq(l);if(c.length<=0)break;if(c.removeClass("removeCell"),!c.hasClass("ng-hide")&&"none"!=c.css("display")){var f=parseInt(c.attr("colspan")||1),p=parseInt(c.attr("rowspan")||0),h=e.eq(o).find("td").eq(l)[0].getBoundingClientRect().width;d+=1,b+=h,t+=f;for(var g=1;g<p;g++)n[o+g]||(n[o+g]=0),n[o+g]+=1,n[o+g]>=u&&(n[o+g]=u),i[o+g]||(i[o+g]=0),i[o+g]+=h,i[o+g]>=b&&(i[o+g]=b);if(u<=d)break}}if(u<=d)break}return t}():0;e&&a&&(t["sticky-col"]=a.is(":visible"),t.left=a.css("left"),a.css({display:"table"}),y.find("thead").clone(),a.find("thead").remove().end().prepend(y.find("thead").clone()),n=a,f=i,p=y.find("tbody tr"),h={},g={},n.find("tbody tr").each(function(e){for(var t=$(this).find("td"),n=t.length,i=0,d=h[e]||0,i=(g[e],0);i<n;i++){var a=t.eq(i);if(a.length<=0)break;if(a.removeClass("removeCell"),!a.hasClass("ng-hide")&&"none"!=a.css("display")){var o=parseInt(a.attr("colspan")||1),s=parseInt(a.attr("rowspan")||0),r=p.eq(e).find("td").eq(i)[0].getBoundingClientRect().width;if(!(d<f)){--i;break}d+=o;for(var l=1;l<s;l++)h[e+l]||(h[e+l]=0),h[e+l]+=1,h[e+l]>=u&&(h[e+l]=u),g[e+l]||(g[e+l]=0),g[e+l]+=r,g[e+l]>=b&&(g[e+l]=b);var c=p.eq(e).find("td").eq(i);if(a.outerHeight(c[0].getBoundingClientRect().height).outerWidth(c[0].getBoundingClientRect().width).css({"padding-right":c.css("padding-right")?c.css("padding-right"):0,"padding-left":c.css("padding-left")?c.css("padding-left"):0,"padding-top":0,"padding-bottom":0,"vertical-align":"middle"}),f<=d){a.attr("colspan",o-(d-f)),(g[e]||b<0+r)&&a.outerWidth(b-(g[e]||0));break}g[e]+=r}}(i<0?$(this).find("td"):$(this).find("td:gt("+(i||0)+")")).addClass("removeCell")}),s(a,i),a.css({width:b,"max-width":"none","border-width":"none","margin-bottom":"0px"}),t["sticky-col"]?a.css({opacity:1,display:"table",left:t.left}):a.css({opacity:0,display:"none"})),e&&o&&(t["sticky-intersect"]=o.is(":visible"),t.top=o.css("top"),t.left=o.css("left"),o.css({display:"table"}),s(o,i),o.css({width:b+1,"max-width":"none","border-width":"none","margin-bottom":"0px"}),t["sticky-intersect"]?o.css({opacity:1,display:"table",top:t.top,left:t.left}):o.css({opacity:0,display:"none"}))};l._top=function(){0<$(c).find("[function-type]").length&&!i&&(i=!0,f(function(){r()})),y.height()>t.height()&&0<t.scrollTop()?(d&&d.css({top:l.eTop&&"true"===l.eTop?t.scrollTop()-1:0,"max-width":"none","border-width":"none",opacity:l.eTop&&"true"===l.eTop?1:0,display:l.eTop&&"true"===l.eTop?"table":"none","box-shadow":l.eTop&&"true"===l.eTop?"rgba(153, 153, 153, .8) 2px 2px 12px":"initial"}),o&&o.css({top:l.eTop&&"true"===l.eTop?t.scrollTop()-1:0,opacity:1,display:"table"})):(y.find("thead").css({opacity:1}),d&&d.css({top:0,"box-shadow":"initial"}),o&&o.css({top:0}))},l._left=function(){u&&(y.width()>t.width()&&0<t.scrollLeft()?0<y.find("tbody tr").length&&(a&&a.css({display:"initial",top:0,left:t.scrollLeft(),width:b,"max-width":"none","border-width":"none",opacity:1}),o&&o.css({left:t.scrollLeft(),width:b+1,"max-width":"none","border-width":"none",opacity:1,display:"table"})):(a&&a.css({opacity:0,display:"none"}),o&&o.css({opacity:0,display:"none"})))},r()}}}}]);