angular.module("multi-select",["ng"]).directive("multiSelect",["$sce","$timeout",function(e,t){return{restrict:"AE",replace:!0,scope:{inputModel:"=",outputModel:"=",initialResult:"=",outputResult:"=",buttonLabel:"@",defaultLabel:"@",directiveId:"@",helperElements:"@",isDisabled:"=",itemLabel:"@",maxLabels:"@",orientation:"@",selectionMode:"@",tickProperty:"@",disableProperty:"@",groupProperty:"@",maxHeight:"@",onClose:"&",onItemClick:"&",onOpen:"&"},template:'<span class="multiSelect inlineBlock"><button type="button" class="button multiSelectButton" ng-click="toggleCheckboxes( $event ); refreshSelectedItems(); refreshButton();" ng-bind-html="varButtonLabel"></button><div class="checkboxLayer"><form><div class="helperContainer" ng-if="displayHelper( \'filter\' ) || displayHelper( \'all\' ) || displayHelper( \'none\' ) || displayHelper( \'reset\' )"><div class="line" ng-if="displayHelper( \'all\' ) || displayHelper( \'none\' ) || displayHelper( \'reset\' )"><button type="button" ng-click="select( \'all\',   $event );"    class="helperButton" ng-if="!isDisabled && displayHelper( \'all\' )">   &#10003;&nbsp; Select All</button> <button type="button" ng-click="select( \'none\',  $event );"   class="helperButton" ng-if="!isDisabled && displayHelper( \'none\' )">  &times;&nbsp; Select None</button><button type="button" ng-click="select( \'reset\', $event );"  class="helperButton" ng-if="!isDisabled && displayHelper( \'reset\' )" style="float:right">&#8630;&nbsp; Reset</button></div><div class="line" style="position:relative" ng-if="displayHelper( \'filter\' )"><input placeholder="Search..." type="text" ng-click="select( \'filter\', $event )" ng-model="inputLabel.labelFilter" ng-change="updateFilter();$scope.getFormElements();" class="inputFilter" /><button type="button" class="clearButton" ng-click="inputLabel.labelFilter=\'\';updateFilter();prepareGrouping();prepareIndex();select( \'clear\', $event )">&times;</button> </div></div><div class="checkBoxContainer" style="{{setHeight();}}"><div ng-repeat="item in filteredModel | filter:removeGroupEndMarker" class="multiSelectItem"ng-class="{selected: item[ tickProperty ], horizontal: orientationH, vertical: orientationV, multiSelectGroup:item[ groupProperty ], disabled:itemIsDisabled( item )}"ng-click="syncItems( item, $event, $index );"ng-mouseleave="removeFocusStyle( tabIndex );"><div class="acol" ng-if="item[ spacingProperty ] > 0" ng-repeat="i in numberToArray( item[ spacingProperty ] ) track by $index">&nbsp;</div><div class="acol"><label><input class="checkbox focusable" type="checkbox" ng-disabled="itemIsDisabled( item )" ng-checked="item[ tickProperty ]" ng-click="syncItems( item, $event, $index )" /><span ng-class="{disabled:itemIsDisabled( item )}" ng-bind-html="writeLabel( item, \'itemLabel\' )"></span></label></div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tickMark" ng-if="item[ groupProperty ] !== true && item[ tickProperty ] === true">&#10004;</span></div></div></form></div></span>',link:function(n,r,l){n.backUp=[],n.varButtonLabel="",n.scrolled=!1,n.spacingProperty="",n.indexProperty="",n.checkBoxLayer="",n.orientationH=!1,n.orientationV=!0,n.filteredModel=[],n.inputLabel={labelFilter:""},n.selectedItems=[],n.formElements=[],n.tabIndex=0,n.clickedItem=null,prevTabIndex=0,helperItems=[],helperItemsLength=0,n.setHeight=function(){return"undefined"!=typeof n.maxHeight?"max-height: "+n.maxHeight+"; overflow-y:scroll":void 0},n.numberToArray=function(e){return new Array(e)},n.updateFilter=function(){n.filteredModel=[];var e=0;if("undefined"==typeof n.inputModel)return[];for(e=n.inputModel.length-1;e>=0;e--){"undefined"!=typeof n.inputModel[e][n.groupProperty]&&n.inputModel[e][n.groupProperty]===!1&&n.filteredModel.push(n.inputModel[e]);var r=!1;if("undefined"==typeof n.inputModel[e][n.groupProperty]){for(var l in n.inputModel[e])if("boolean"!=typeof n.inputModel[e][l]&&String(n.inputModel[e][l]).toUpperCase().indexOf(n.inputLabel.labelFilter.toUpperCase())>=0){r=!0;break}r===!0&&n.filteredModel.push(n.inputModel[e])}"undefined"!=typeof n.inputModel[e][n.groupProperty]&&n.inputModel[e][n.groupProperty]===!0&&("undefined"!=typeof n.filteredModel[n.filteredModel.length-1][n.groupProperty]&&n.filteredModel[n.filteredModel.length-1][n.groupProperty]===!1?n.filteredModel.pop():n.filteredModel.push(n.inputModel[e]))}n.filteredModel.reverse(),t(function(){n.getFormElements()},0)},n.getFormElements=function(){n.formElements=[];for(var e=0;e<r[0].getElementsByTagName("FORM")[0].elements.length;e++)n.formElements.push(r[0].getElementsByTagName("FORM")[0].elements[e])},n.isGroupMarker=function(e,t){return"undefined"!=typeof e[n.groupProperty]&&e[n.groupProperty]===t?!0:!1},n.removeGroupEndMarker=function(e){return"undefined"!=typeof e[n.groupProperty]&&e[n.groupProperty]===!1?!1:!0},n.displayHelper=function(e){if(l.selectionMode&&"SINGLE"===n.selectionMode.toUpperCase()){switch(e.toUpperCase()){case"ALL":return!1;case"NONE":return!1;case"RESET":if("undefined"==typeof l.helperElements)return!0;if(l.helperElements&&n.helperElements.toUpperCase().indexOf("RESET")>=0)return!0;break;case"FILTER":if("undefined"==typeof l.helperElements)return!0;if(l.helperElements&&n.helperElements.toUpperCase().indexOf("FILTER")>=0)return!0}return!1}return"undefined"==typeof l.helperElements?!0:l.helperElements&&n.helperElements.toUpperCase().indexOf(e.toUpperCase())>=0?!0:!1},n.syncItems=function(e,t,r){if(t.preventDefault(),t.stopPropagation(),"undefined"!=typeof l.disableProperty&&e[n.disableProperty]===!0)return!1;if("undefined"!=typeof l.isDisabled&&n.isDisabled===!0)return!1;if("undefined"!=typeof e[n.groupProperty]&&e[n.groupProperty]===!1)return!1;if(index=n.filteredModel.indexOf(e),"undefined"!=typeof e[n.groupProperty]&&e[n.groupProperty]===!0){if(l.selectionMode&&"SINGLE"===n.selectionMode.toUpperCase())return!1;var o,i,a=0,d=n.filteredModel.length-1,p=[],s=0;for(o=index;o<n.filteredModel.length&&!(0===s&&o>index);o++)if("undefined"!=typeof n.filteredModel[o][n.groupProperty]&&n.filteredModel[o][n.groupProperty]===!0)0===p.length&&(a=o+1),s+=1;else if("undefined"!=typeof n.filteredModel[o][n.groupProperty]&&n.filteredModel[o][n.groupProperty]===!1){if(s-=1,p.length>0&&0===s){var u=!0;for(d=o,i=0;i<p.length;i++)if("undefined"!=typeof p[i][n.tickProperty]&&p[i][n.tickProperty]===!1){u=!1;break}if(u===!0)for(i=a;d>=i;i++)"undefined"==typeof n.filteredModel[i][n.groupProperty]&&("undefined"==typeof l.disableProperty?(n.filteredModel[i][n.tickProperty]=!1,inputModelIndex=n.filteredModel[i][n.indexProperty],n.inputModel[inputModelIndex][n.tickProperty]=!1):n.filteredModel[i][n.disableProperty]!==!0&&(n.filteredModel[i][n.tickProperty]=!1,inputModelIndex=n.filteredModel[i][n.indexProperty],n.inputModel[inputModelIndex][n.tickProperty]=!1));else for(i=a;d>=i;i++)"undefined"==typeof n.filteredModel[i][n.groupProperty]&&("undefined"==typeof l.disableProperty?(n.filteredModel[i][n.tickProperty]=!0,inputModelIndex=n.filteredModel[i][n.indexProperty],n.inputModel[inputModelIndex][n.tickProperty]=!0):n.filteredModel[i][n.disableProperty]!==!0&&(n.filteredModel[i][n.tickProperty]=!0,inputModelIndex=n.filteredModel[i][n.indexProperty],n.inputModel[inputModelIndex][n.tickProperty]=!0))}}else p.push(n.filteredModel[o])}else{if(l.selectionMode&&"SINGLE"===n.selectionMode.toUpperCase()){for(o=0;o<n.filteredModel.length;o++)n.filteredModel[o][n.tickProperty]=!1;for(o=0;o<n.inputModel.length;o++)n.inputModel[o][n.tickProperty]=!1;n.filteredModel[index][n.tickProperty]=!0,n.toggleCheckboxes(t)}else n.filteredModel[index][n.tickProperty]=!n.filteredModel[index][n.tickProperty];inputModelIndex=n.filteredModel[index][n.indexProperty],n.inputModel[inputModelIndex][n.tickProperty]=n.filteredModel[index][n.tickProperty]}n.clickedItem=angular.copy(e),prevTabIndex=n.tabIndex,n.tabIndex=r+helperItemsLength,t.target.focus(),n.removeFocusStyle(prevTabIndex),n.setFocusStyle(n.tabIndex)},n.refreshSelectedItems=function(){n.selectedItems=[],angular.forEach(n.inputModel,function(e,t){"undefined"!=typeof e&&"undefined"==typeof e[n.groupProperty]&&e[n.tickProperty]===!0&&n.selectedItems.push(e)})},n.refreshOutputModel=function(){"undefined"!=typeof l.outputModel&&(n.outputModel=angular.copy(n.selectedItems),angular.forEach(n.outputModel,function(e,t){delete e[n.indexProperty],delete e[n.spacingProperty]})),n.refreshOutputResult()},n.refreshOutputResult=function(){try{if(n.selectedItems.length>0){var e=[];angular.forEach(n.selectedItems,function(t){e.push(t.code_id)}),n.outputResult=e.join(",")}else n.outputResult=""}catch(t){}},n.refreshButton=function(){if(n.varButtonLabel="",ctr=0,0===n.selectedItems.length)n.varButtonLabel="undefined"!=typeof n.defaultLabel?n.defaultLabel:"　　　　　";else{var t=n.selectedItems.length;"undefined"!=typeof n.maxLabels&&""!==n.maxLabels&&(t=n.maxLabels),n.selectedItems.length>t?n.more=!0:n.more=!1,angular.forEach(n.selectedItems,function(e,r){"undefined"!=typeof e&&(ctr<t&&(n.varButtonLabel+=(n.varButtonLabel.length>0?'</div>, <div class="buttonLabel">':'<div class="buttonLabel">')+n.writeLabel(e,"buttonLabel")),ctr++)}),n.more===!0&&(t>0&&(n.varButtonLabel+=", ... "),n.varButtonLabel+="(Total: "+n.selectedItems.length+")")}n.varButtonLabel=e.trustAsHtml(n.varButtonLabel+'<span class="caret"></span>')},n.itemIsDisabled=function(e){return"undefined"!=typeof l.disableProperty&&e[n.disableProperty]===!0?!0:n.isDisabled===!0?!0:!1},n.writeLabel=function(t,r){var l="",o=n[r].split(" ");return angular.forEach(o,function(e,n){"undefined"!=typeof e&&angular.forEach(t,function(t,n){n==e&&(l+="&nbsp;"+t)})}),"BUTTONLABEL"===r.toUpperCase()?l:e.trustAsHtml(l)},n.toggleCheckboxes=function(e){if(n.checkBoxLayer=r.children()[1],clickedEl=r.children()[0],angular.element(document).unbind("click",n.externalClickListener),angular.element(document).unbind("keydown",n.keyboardListener),n.inputLabel.labelFilter="",n.updateFilter(),27===e.keyCode)return angular.element(n.checkBoxLayer).removeClass("show"),angular.element(clickedEl).removeClass("buttonClicked"),angular.element(document).unbind("click",n.externalClickListener),angular.element(document).unbind("keydown",n.keyboardListener),n.removeFocusStyle(n.tabIndex),n.onClose({data:r}),!0;if(angular.element(n.checkBoxLayer).hasClass("show"))angular.element(n.checkBoxLayer).removeClass("show"),angular.element(clickedEl).removeClass("buttonClicked"),angular.element(document).unbind("click",n.externalClickListener),angular.element(document).unbind("keydown",n.keyboardListener),n.removeFocusStyle(n.tabIndex),n.onClose({data:r});else{helperItems=[],helperItemsLength=0,angular.element(n.checkBoxLayer).addClass("show"),angular.element(clickedEl).addClass("buttonClicked"),angular.element(document).bind("click",n.externalClickListener),angular.element(document).bind("keydown",n.keyboardListener),n.getFormElements(),n.tabIndex=0;var t=angular.element(r[0].querySelector(".helperContainer"))[0];if("undefined"!=typeof t){for(i=0;i<t.getElementsByTagName("BUTTON").length;i++)helperItems[i]=t.getElementsByTagName("BUTTON")[i];helperItemsLength=helperItems.length+t.getElementsByTagName("INPUT").length}r[0].querySelector(".inputFilter")?(r[0].querySelector(".inputFilter").focus(),n.tabIndex=n.tabIndex+helperItemsLength-2):n.formElements[n.tabIndex].focus(),n.onOpen({data:r})}},n.externalClickListener=function(e){targetsArr=r.find(e.target.tagName);for(var l=0;l<targetsArr.length;l++)if(e.target==targetsArr[l])return;angular.element(n.checkBoxLayer.previousSibling).removeClass("buttonClicked"),angular.element(n.checkBoxLayer).removeClass("show"),angular.element(document).unbind("click",n.externalClickListener),angular.element(document).unbind("keydown",n.keyboardListener),t(function(){n.onClose({data:r})},0)},n.findUpTag=function(e,t,n){for(;e.parentNode;)if(e=e.parentNode,"undefined"!=typeof e.tagName&&e.tagName.toUpperCase()===t.toUpperCase()&&e.className.indexOf(n)>-1)return e;return null},n.select=function(e,t){switch(helperIndex=helperItems.indexOf(t.target),n.tabIndex=helperIndex,e.toUpperCase()){case"ALL":angular.forEach(n.filteredModel,function(e,t){"undefined"!=typeof e&&e[n.disableProperty]!==!0&&"undefined"==typeof e[n.groupProperty]&&(e[n.tickProperty]=!0)});break;case"NONE":angular.forEach(n.filteredModel,function(e,t){"undefined"!=typeof e&&e[n.disableProperty]!==!0&&"undefined"==typeof e[n.groupProperty]&&(e[n.tickProperty]=!1)});break;case"RESET":angular.forEach(n.filteredModel,function(e,t){"undefined"==typeof e[n.groupProperty]&&"undefined"!=typeof e&&e[n.disableProperty]!==!0&&(temp=e[n.indexProperty],e[n.tickProperty]=n.backUp[temp][n.tickProperty])});break;case"CLEAR":n.tabIndex=n.tabIndex+1;break;case"FILTER":n.tabIndex=helperItems.length-1}},genRandomString=function(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",n="",r=0;e>r;r++)n+=t.charAt(Math.floor(Math.random()*t.length));return n},n.prepareGrouping=function(){var e=0;angular.forEach(n.filteredModel,function(t,r){t[n.spacingProperty]=e,t[n.groupProperty]===!0?e+=2:t[n.groupProperty]===!1&&(e-=2)})},n.prepareIndex=function(){ctr=0,angular.forEach(n.filteredModel,function(e,t){e[n.indexProperty]=ctr,ctr++})},n.keyboardListener=function(e){var t=e.keyCode?e.keyCode:e.which,r=!1;if(27===t)n.toggleCheckboxes(e);else if(40===t||39===t||!e.shiftKey&&9==t)for(r=!0,prevTabIndex=n.tabIndex,n.tabIndex++,n.tabIndex>n.formElements.length-1&&(n.tabIndex=0,prevTabIndex=n.formElements.length-1);n.formElements[n.tabIndex].disabled===!0;)n.tabIndex++,n.tabIndex>n.formElements.length-1&&(n.tabIndex=0);else if(38===t||37===t||e.shiftKey&&9==t)for(r=!0,prevTabIndex=n.tabIndex,n.tabIndex--,n.tabIndex<0&&(n.tabIndex=n.formElements.length-1,prevTabIndex=0);n.formElements[n.tabIndex].disabled===!0;)n.tabIndex--,n.tabIndex<0&&(n.tabIndex=n.formElements.length-1);if(r===!0){e.preventDefault(),e.stopPropagation(),n.formElements[n.tabIndex].focus();var l=document.activeElement;"CHECKBOX"===l.type.toUpperCase()?(n.setFocusStyle(n.tabIndex),n.removeFocusStyle(prevTabIndex)):(n.removeFocusStyle(prevTabIndex),n.removeFocusStyle(helperItemsLength),n.removeFocusStyle(n.formElements.length-1))}r=!1},n.setFocusStyle=function(e){angular.element(n.formElements[e]).parent().parent().parent().addClass("multiSelectFocus")},n.removeFocusStyle=function(e){angular.element(n.formElements[e]).parent().parent().parent().removeClass("multiSelectFocus")};var o=genRandomString(5);n.indexProperty="idx_"+o,n.spacingProperty="spc_"+o,"undefined"!=typeof l.orientation&&("HORIZONTAL"===l.orientation.toUpperCase()?(n.orientationH=!0,n.orientationV=!1):(n.orientationH=!1,n.orientationV=!0)),n.$watch("inputModel",function(e){e&&(n.refreshSelectedItems(),n.refreshOutputModel(),n.refreshButton(),null!==n.clickedItem&&t(function(){n.onItemClick({data:n.clickedItem}),n.clickedItem=null},0))},!0),n.$watch("inputModel",function(e){e&&(n.backUp=angular.copy(n.inputModel),n.updateFilter(),n.prepareGrouping(),n.prepareIndex(),n.refreshSelectedItems(),n.refreshOutputModel(),n.refreshButton())}),n.$watch("initialResult",function(e){try{if("string"==typeof l.initialResult){var t=e.split(",");angular.forEach(n.inputModel,function(e,r){"undefined"!=typeof e&&angular.forEach(t,function(t){e.code_id===t&&(e[n.tickProperty]=!0)})})}}catch(r){}},!0),n.$watch("isDisabled",function(e){n.isDisabled=e}),angular.element(document).bind("touchstart",function(e){n.$apply(function(){n.scrolled=!1})}),angular.element(document).bind("touchmove",function(e){n.$apply(function(){n.scrolled=!0})}),Array.prototype.indexOf||(Array.prototype.indexOf=function(e,t){t=t||0;for(var n=this.length;n>t;){if(this[t]===e)return t;++t}return-1})}}}]);