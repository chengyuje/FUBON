eSoafApp.directive("eCombobox",["projInfoService","getParameter","$timeout","$q",function(u,p,h,e){return{restrict:"E",transclude:!0,replace:!0,scope:{id:"@",ngDisabled:"=?",ngRequired:"=?",ngReadonly:"=?",ngModel:"=?",ngDatasource:"=?",ngParamtype:"=?",ngValue:"=?",ngLabel:"=?",ngItem:"=?",ngEditable:"=?",ngValidate:"=?",ngFormat:"@",ngChange:"&?ngChange",width:"@",height:"@",blankRow:"@",modelName:"@?ngModel",replace:"=?",multiple:"@?",separator:"@?",labelSeparator:"@?"},template:function(e,t){return t.multiple?'<div class="multiselect">    <div class="selectBox">      <select class="combobox">        <option>{{selected || "請選擇"}}</option>      </select>      <div class="overSelect"></div>    </div>    <div class="checkboxes">\t\t  <label style="color: #1c94c4; font-size: 1.1em; display: block;"  \t\t\t\t onmouseover="this.style.background=\'#FEF6D1\'; this.style.color=\'#C77405\'; "   \t\t\t\t onmouseout="this.style.background=\'#F9F9F9\'; this.style.color=\'#1c94c4\'; "  \t\t\t\t ng-repeat="each in ngDatasource track by $index"\t\t\t\t ng-if="each.DATA">\t\t\t<input class="checkboxValue" type="checkbox" ng-model="each.checked" \t\t\t\t   value="{{each.DATA}}" />&emsp;{{each.LABEL}}</label>    </div>  </div>':'<span class="e-combobox" style="white-space: nowrap"><input name="'+t.id+'" style="line-height:normal!important;"/><button type="button"></button><button type="button" ng-click="Refresh()"></button></span>'},link:function(c,l,s,e,t){function n(e){if(s.ngFormat){for(var t=0;t<e.length;t+=1)"請選擇"==e[t].label&&e.splice(t,1);angular.forEach(e,function(e,t,a){switch(s.ngFormat){case"F1":e.orgLabel=e.LABEL?e.LABEL.toString().trim():"",e.value=e.DATA,e.DATA&&""!==e.DATA.toString().trim()&&e.LABEL&&""!==e.LABEL.toString().trim()&&(e.label=e.DATA+"-"+e.LABEL.toString().trim()),e.DATA&&""!==e.DATA.toString().trim()||!e.LABEL||""===e.LABEL.toString().trim()||(e.label=e.LABEL.toString().trim()),e.LABEL&&""!==e.LABEL.toString().trim()||!e.DATA||""===e.DATA.toString().trim()||(e.label=e.DATA.toString().trim());break;case"F2":e.orgLabel=e.LABEL?e.LABEL.toString().trim():"",e.label=e.DATA,e.value=e.DATA;break;case"F3":default:e.orgLabel=e.LABEL?e.LABEL.toString().trim():"",e.label=e.LABEL?e.LABEL.toString().trim():"",e.value=e.DATA}})}var a=!1;if(angular.forEach(e,function(e){e.label&&"請選擇"===e.label.toString().trim()&&(a=!0)}),!a){for(var n="",t=0;t<e.length;t+=1)if(e[t].value&&"STRING"!==(typeof e[t].value).toUpperCase()){n=null;break}e.unshift({LABEL:"請選擇",DATA:n,orgLabel:"請選擇",label:"請選擇",value:n})}for(t=0;t<e.length;t+=1)null==e[t].label&&null==e[t].value&&e.splice(t,1);return e}function a(){angular.isDefined(c.ngDatasource)||p.XML(s.ngParamtype,function(e){e?(d.hide(),g.show(),r.attr("disabled",c.ngDisabled),c.ngDatasource=e.data[0],r.autocomplete({source:n(c.ngDatasource)})):(d.show(),g.hide(),r.attr("disabled",!0),r.attr("placeholder","發生錯誤，請重新整理"))},function(){if(angular.isDefined(c.replace))return c.replace})}function o(n,e,o){var l;n.ngDatasource&&(l=!0,angular.forEach(e.autocomplete("option","source"),function(e,t,a){l&&e.DATA==o&&(n.ngLable=e.label,n.ngItem=e,l=!1)})),e.val(n.ngLable)}function i(e,t,a){if("data-source-local"===e)angular.isDefined(c.ngDatasource)&&angular.isDefined(t)&&(angular.isDefined(t)&&angular.isDefined(a)&&t===a||(c.ngLable="請選擇","[object Array]"===Object.prototype.toString.call(t)?r.autocomplete({source:n(t)}):r.autocomplete({source:n(c.ngDatasource)}),c.ngModel?o(c,r,c.ngModel):r.val("請選擇")))}var r,g,d;s.multiple?function(i){angular.isDefined(c.ngDatasource)||p.XML(s.ngParamtype,function(e){e&&(c.ngDatasource=e.data[0])});const e=$(l),a=e.children(":nth-child(1)"),n=e.children(":nth-child(2)"),o=a.children(":nth-child(1)"),t=a.children(":nth-child(2)");a.on("click",()=>n.show()).css("position","relative"),n.on("click",e=>{if("[object HTMLInputElement]"===e.target.toString()){const t=c.ngDatasource.filter(e=>e.checked);c.ngModel=t.map(e=>e.DATA).join(i.separator)}}).on("mouseleave",e=>{n.hide()}).css("display","none").css("border","1px #dadada solid").css("position","absolute").css("min-width","200px").css("max-height","165px").css("background","#F9F9F9").css("overflow","auto").css("padding","0px 10px").css("zIndex","1"),e.css("width","200px"),o.css("width","100%").css("fontWeight","bold").css("paddingLeft","10px").css("height","30px").addClass("custom-combobox-input ui-widget ui-widget-content ui-state-default ui-corner-left"),t.css("position","absolute").css("left","0").css("right","0").css("top","0").css("bottom","0"),c.$watch("ngModel",function(e,t){if(e){const o=e.split(i.separator);c.ngDatasource.forEach(e=>e.checked=o.contains(e.DATA));const l=c.ngDatasource.filter(e=>e.checked);var a=l.map(e=>e.LABEL).join(i.labelSeparator),n=l.length;c.selected=0===n?"請選擇":a.length<20?a:n+" items selected"}t&&!e&&(c.ngDatasource=c.ngDatasource.map(e=>_.omit(e,"checked")),c.selected="請選擇"),e!==t&&angular.isDefined(i.ngChange)&&c.ngChange()}),c.$watch("ngDisabled",function(e,t){o.prop("disabled",c.ngDisabled),c.ngDisabled||c.ngReadonly?a.unbind("click"):a.on("click",()=>n.show())}),c.$watch("ngReadonly",function(e,t){o.prop("readonly",c.ngReadonly),c.ngReadonly||c.ngDisabled?a.unbind("click"):a.on("click",()=>n.show())}),c.$watch("ngRequired",function(e,t){o.prop("required",c.ngRequired)})}(s):(r=$(l).children(":nth-child(1)"),g=$(l).children(":nth-child(2)"),d=$(l).children(":nth-child(3)"),c.height=c.height||"30px",t(function(e){l.parent().append(e)}),$(l).addClass("custom-combobox").css("position","relative").css("display","inline-block"),function(){c.modelName=c.modelName.toString().trim(),-1!==c.modelName.indexOf(".")?c.str=c.modelName.split("."):c.str=!1,c.ngDatasource,s.ngParamtype&&a();var e=[];c.ngDatasource&&(e=n(c.ngDatasource)),r.addClass("custom-combobox-input ui-widget ui-widget-content ui-state-default ui-corner-left").css("margin","0").css("padding","5px 10px").css("width",s.width).autocomplete({delay:0,minLength:0,focus:function(e,t){return r.val(t.item.label),!1},select:function(e,t){return $(r).val(t.item.label),!1},source:e}).tooltip({tooltipClass:"ui-state-highlight"}),e&&c.ngModel?o(c,r,c.ngModel):r.val("請選擇"),c.$watch("ngDisabled",function(e,t){e!==t&&(r.prop("disabled",c.ngDisabled),g.prop("disabled",c.ngDisabled||c.ngReadonly),d.prop("disabled",c.ngDisabled))}),c.$watch("ngRequired",function(e,t){e!==t&&r.prop("required",c.ngRequired)}),c.$watch("ngReadonly",function(e,t){e!==t&&(r.prop("readonly",c.ngReadonly),g.prop("disabled",c.ngDisabled||c.ngReadonly))}),c.$watch("ngDatasource",function(e,t){i("data-source-local",e,t)}),c.$watch("ngModel",function(e,t){e!==t&&(angular.isDefined(s.ngChange)&&c.ngChange(),e?e!=c.ngValue&&(c.ngValue=e,o(c,r,e)):(r.val("請選擇"),c.ngModel="",c.ngValue="",c.ngLable="請選擇",c.ngItem=null))}),r.on("click",function(e){c.ngDisabled||c.ngReadonly||(wasOpen=r.autocomplete("widget").is(":visible"),wasOpen||("請選擇"==r.val()&&r.val(""),r.autocomplete("search","")))}),r.on("keydown",function(e){c.ngEditable||e.preventDefault()}),r.on("blur",function(e){c.ngLable="請選擇",c.ngModel?o(c,r,c.ngModel):r.val("請選擇")}),r.on("autocompleteselect",function(e,t){for(var a=0;a<c.ngDatasource.length;a+=1)if(c.ngDatasource[a].label===r.val()){c.$parent[c.modelName.toString()]=c.ngDatasource[a].value;break}var n=s.placeholder||u.eComboPlaceholder;t.item.value==n?(r.autocomplete("instance").term="",c.ngModel="",c.ngValue="",c.ngLabel="",c.ngItem=""):(c.ngModel=t.item.value,c.ngValue=t.item.value,c.ngLabel=t.item.orgLabel,c.ngItem=t.item)}),r.on("autocompletechange",function(e,t){var a,n,o,l;0!=c.ngValidate&&(a=c,n=r,(t=t).item||(o=(t=n.val()).toLowerCase(),l=!1,angular.forEach(a.ngDatasource,function(e,t){e.label.toLowerCase()===o&&(l=!0)}),l||(a.$parent.showErrorMsg(t+" 不在下拉選單中"),n.val("").attr("title",t+" 不在下拉選單中").tooltip("open"),n.on("tooltipclose",function(e,t){n.attr("title","").tooltip("close")}),n.autocomplete("instance").term="")))}),$("html, body").on("scroll",function(){r.autocomplete().autocomplete("close")})}(),r.css("height",c.height).css("vertical-align","middle"),d.attr("tabIndex",-1).attr("title","Refresh").button({icons:{primary:"ui-icon-arrowrefresh-1-e"},text:!1}).removeClass("ui-corner-all").addClass("custom-combobox-toggle ui-corner-right").css("vertical-align","middle").css("margin-left","-1px").css("height",c.height).css("padding","0"),d.hide(),g.attr("tabIndex",-1).tooltip().button({icons:{primary:"ui-icon-triangle-1-s"},text:!1}).removeClass("ui-corner-all").addClass("custom-combobox-toggle ui-corner-right").css("vertical-align","middle").css("height",c.height).css("margin-left","-1px").css("padding","0").on("mousedown",function(){wasOpen=r.autocomplete("widget").is(":visible")}).on("click",function(e){e.preventDefault(),r.trigger("focus"),wasOpen||r.autocomplete("search","")}),c.Refresh=function(){s.ngParamtype&&a()},h(function(){i("data-source-local",!0,!1)}),$(".ui-autocomplete").css("max-height","150px").css("overflow-y","auto").css("overflow-x","hidden").css("white-space","nowrap"),r.prop("required",c.ngRequired),r.prop("readonly",c.ngReadonly),r.prop("disabled",c.ngDisabled),g.prop("disabled",c.ngDisabled||c.ngReadonly),d.prop("disabled",c.ngDisabled))}}}]);
