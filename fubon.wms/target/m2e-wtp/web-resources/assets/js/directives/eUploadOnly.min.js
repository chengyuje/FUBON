/**================================================================================================
@program: eUploadOnly.js
@description: 
@version: 1.0.20170313
=================================================================================================*/
eSoafApp.directive("eUploadOnly",["sysInfoService","$rootScope","$q",function(e,t,r){return{restrict:"E",transclude:!0,replace:!0,scope:{model:"=?",allow:"@?",accept:"@?",success:"&",fail:"&",process:"=?",processStr:"@?process",eDisabled:"=?"},template:function(e,t){var r='<div>	<table><tr>		<td><span id="filebtn" class="btn btn-info fileinput-button">				<input id="fileup" type="file" ng-model="eUpload_input">    			<span>{{text}}</span>		</span></td>	</tr></table></div>';return r},link:function(a,n,i,s){a.showBar=!1;var l=$(n).find("#filebtn");a.eDisabled&&(a.eDisabled===!0?l.attr("disabled",!0):l.attr("disabled",!1));var o=$(n).find("#fileup"),p={str:!1,size:!1},u=[function(){var t=r.defer();return p.str=$.map(e.getFileParameter(),function(e){return"DEFAULT"==e.DATA?e.LABEL.toString().trim():void 0})[0],t.resolve(p.str),t.promise},function(){var t=r.defer();return p.size=$.map(e.getFileParameter(),function(e){return"DEFAULT"==e.DATA?1024*parseInt(e.LABEL.toString().trim())*1024:void 0})[0],t.resolve(p.size),t.promise}];r.all([u[0](),u[1]()]).then(function(){var t=$.map(e.getFileParameter(),function(e){return e.DATA==a.$parent.authority_txnName?parseInt(e.LABEL.toString().trim()):void 0})[0];t&&(p.str=t,p.size=1024*t*1024)}).then(function(){a.text="瀏覽",$(o).fileupload({url:"FileUpload",dataType:"json",replaceFileInput:!1,change:function(e,r){var n=r.files[0].name.split(".")[r.files[0].name.split(".").length-1];if(a.allow){-1!==a.allow.indexOf(".")&&(a.allow=a.allow.replace(".",""));var i=a.allow.split(",");if(-1===i.indexOf(n))return a.value="",t.showWarningMsg("上傳檔案類型錯誤，檔案格式限定"+a.allow+"。"),!1}if(a.accept){-1!==a.accept.indexOf(".")&&(a.accept=a.accept.replace(".",""));var s=a.accept.split(",");if(-1===s.indexOf(n))return a.value="",t.showWarningMsg("上傳檔案類型錯誤，檔案格式限定"+a.accept+"。"),!1}if(r.files[0].size>p.size)return a.value="",t.showWarningMsg("檔案大小不能超過"+p.str+"Mb。"),!1;a.showBar=!0,a.$parent[a.processStr]=0,l.attr("disabled",!0);var u=this,c=/(?:\.([^.]+))?$/;$.each(r.files,function(e,t){var r=uuid(),n=c.exec(t.name)[1],i=t.name,s=t.size;void 0!=n&&(r+="."+n);var l="temp/"+r;$(o).attr("fullPath",l),$(o).attr("name",r),$(o).attr("rname",i),$(o).attr("size",s),u.name=r,a.value=i})},progressall:function(e,t){if(e.isDefaultPrevented())return!1;var r=($(this),Math.floor(t.loaded/t.total*100));a.w=r,a.wStr=r+"%"},fail:function(e,t,r){return 200==t._response.jqXHR.status?(a.success({tempPath:$(o).attr("tempPath"),fullPath:$(o).attr("fullPath"),name:$(o).attr("name"),rname:$(o).attr("rname"),size:$(o).attr("size")}),$(o).attr("value",""),a.$parent[a.processStr]=100,a.showBar=!1,a.w=0,a.wStr="0%",void l.attr("disabled",!1)):void 0==$(o).attr("error")?(alert("上傳失敗, status["+t._response.jqXHR.status+"]"),a.$parent[a.processStr]=!1,a.showBar=!1,a.w=0,void(a.wStr="0%")):(a.error({status:t._response.jqXHR.status}),a.$parent[a.processStr]=!1,a.showBar=!1,void l.attr("disabled",!1))}})}),angular.isDefined(a.model)&&a.$watch("model",function(e,t){return e&&""!=e?a.value=e:a.value=""})}}}]);